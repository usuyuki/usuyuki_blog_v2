---
import { getLatestArticles } from "~/libs/articleAggregator";
import { iso8601TimeToDate } from "~/libs/helper/iso8601TimeToDate";
import type { ArticleArchiveType } from "~/types/ArticleArchiveType";
import ArchiveList from "./ArchiveList.svelte";

// 全ての記事を取得（Ghost記事とRSS記事を統合）
const allArticles = await getLatestArticles({
	includeExternal: true,
	unlimited: true, // 全記事を取得
});

// 日付でソート（新しい順）
const sortedArticles = allArticles.sort((a, b) => {
	const dateA = new Date(a.published_at as string).getTime();
	const dateB = new Date(b.published_at as string).getTime();
	return dateB - dateA;
});

// 最初のページのデータのみを渡す（12記事まで）
const firstPageArticles = sortedArticles.slice(0, 12);

// 月ごとにグループ化（最初のページのみ）
const groupedPosts: { [key: string]: ArticleArchiveType[] } = {};
firstPageArticles.forEach((article: ArticleArchiveType) => {
	let dateToUse: Date;
	if (typeof article.published_at === "string") {
		dateToUse = new Date(article.published_at);
	} else {
		// DateType format
		dateToUse = new Date(
			`${article.published_at.year}-${article.published_at.month.toString().padStart(2, "0")}-${article.published_at.day.toString().padStart(2, "0")}`,
		);
	}

	const monthKey = `${dateToUse.getFullYear()}-${String(dateToUse.getMonth() + 1).padStart(2, "0")}`;
	if (!groupedPosts[monthKey]) {
		groupedPosts[monthKey] = [];
	}

	// Ghost記事は日付フォーマットを変換、外部記事はそのまま
	if (article.isExternal) {
		groupedPosts[monthKey].push(article);
	} else {
		const date = iso8601TimeToDate(article.published_at as string);
		groupedPosts[monthKey].push({
			...article,
			published_at: date,
		});
	}
});

// 月キーを降順でソート
const sortedMonthKeys = Object.keys(groupedPosts).sort((a, b) =>
	b.localeCompare(a),
);

// 次のページのための基準日付を計算（文字列に変換して確実にシリアライズ可能にする）
let nextBefore: string | null = null;
if (firstPageArticles.length > 0) {
	const lastArticle = firstPageArticles[firstPageArticles.length - 1];
	if (typeof lastArticle.published_at === "string") {
		nextBefore = lastArticle.published_at;
	} else {
		// DateType format を文字列に変換
		nextBefore = `${lastArticle.published_at.year}-${lastArticle.published_at.month.toString().padStart(2, "0")}-${lastArticle.published_at.day.toString().padStart(2, "0")}T00:00:00.000Z`;
	}
}
---

<div class="container mx-auto px-4">
	<h1 class="text-3xl font-bold text-center mb-8">アーカイブ</h1>
	
	<ArchiveList 
		initialPosts={groupedPosts} 
		initialMonthKeys={sortedMonthKeys}
		initialNextBefore={nextBefore}
		client:only="svelte"
	/>
</div>
